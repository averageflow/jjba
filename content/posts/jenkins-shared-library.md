Tired of un-testable, un-reliable, repetitive and tedious scripts to deploy your applications with Jenkins? Look no further, here is your solution.

A good read to get started understanding about why and how we are doing this, is the [Jenkins official documentation](https://www.jenkins.io/doc/book/pipeline/shared-libraries/), which gives a good explanation about this, but quite incomplete when it comes an actual example implementation.

I have taken most of the ideas and the article from [Adrian Kuper](https://dev.to/kuperadrian), thank him and me for this tutorial.

In this blog post I will try to explain how to setup and develop a shared pipeline library for Jenkins, that is easy to work on and can be unit tested with JUnit5 and Mockito.

This blog post is kinda long and touches many topics without explaining them in full detail.

In order to be able to develop deployment pipelines, in the form of shared library, we will need to set up a Java & Groovy development environment.

For that purpose we will need the IntelliJ IDEA IDE that properly supports Java and Groovy and has Gradle support.

You should begin by downloading OpenJDK 8 and installing to your machine, from [here](https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html) . After having installed the package, verify your Java version with the javac -version command, which should display something like:

```
╰─λ javac -version
javac 1.8.0_231
```

Following that you should download the Groovy language SDK from [here](https://groovy.apache.org/download.html) and unzip it into your SDKs folder. Then you should set an environment variable for `GROOVY_HOME` in your shell, for me fish shell:

```
set GROOVY_HOME /Users/joe/Development/SDKs/groovy-3.0.7
```

and augment your path with the groovy bin folder:

    set PATH /Users/joe/Development/SDKs/groovy-3.0.7/bin $PATH

You then have a setup that will be able to run Java and Groovy code without problems.

Then let's create a new IntelliJ IDEA project. I suggest using the IntelliJ IDEA Ultimate for Jenkins shared pipeline development, because it is the only IDE I know of, that properly supports Java and Groovy and has Gradle support, and has excellent plugins, auto-complete and other amazing features. So, if you don't have it installed it yet, go ahead and get a license.

Then you can open up the IDE and create a new project, select Gradle and make sure to set the checkbox on Groovy.

![](/v1610803588/jjba-site/blog/shared-library-jenkins/mvf2arsz0dmpi721uc6l_xdxosk.png)

Next up, enter a GroupId and an ArtifactId.

![](/v1610803587/jjba-site/blog/shared-library-jenkins/6jgw5g2khn8nt9rrc0tp_az9ijw.png)

Ignore the next window (the defaults are fine), click "Next", enter a project name and click "Finish".

![](/v1610803664/jjba-site/blog/shared-library-jenkins/Screenshot-2019-01-04-at-12.14.52_aevfeu.png)

IntelliJ should boot up with your new project. The folder structure in your project should be something like the following.

![](/v1610803663/jjba-site/blog/shared-library-jenkins/Screenshot-2019-01-04-at-12.24.01_qak7rp.png)

This is cool for usual Java/Groovy projects, but for our purpose we have to change things up a bit since Jenkins demands a project structure like this:

        ├── build			# Gradle compilation results
        ├── build.gradle 	# Gradle config for this project
        ├── gradle			# Gradle runtime libraries and JAR files
        ├── gradlew 		# UNIX wrapper to run cradle, generated by the IDE
        ├── reports 		# Custom folder where our test coverage reports will go
        ├── resources		# Necessary resources to run your pipelines, think JSON files, necessary config files
        ├── settings.gradle # Advanced Gradle setttings
        ├── src				# Library code will reside here, this is the source code root, organised as a usual Java project
        │   └── org
        │       └── company
        │           ├── IStepExecutor.groovy
        │           ├── StepExecutor.groovy
        │           ├── ioc
        │           │   ├── ContextRegistry.groovy
        │           │   ├── DefaultContext.groovy
        │           │   └── IContext.groovy
        │           ├── jobs
        │           │   ├── godocs
        │           │   │   └── Job.groovy
        │           └── utils
        │               └── TargetRepository.groovy
        │
        │
        ├── test			# Unit tests for the library code, the contents of this folder will mimic the src folder structure
        │   └── org
        │       └── company
        │           └── jobs
        │               └── godocs
        │                   └── JobTest.groovy
        │
        │
        └── vars			# Globally accessible (from Jenkins) scripts and methods, when loading the library
        	├── godocs_build.groovy
        	└── pipeline.gdsl


Make sure to add to your .gitignore the .gradle, build, reports, .idea folders.

Once you are setup with the project structure like above, edit your build.gradle so that it resembles:

    buildscript {
        repositories {
            mavenCentral()
        }
        dependencies {
            classpath 'com.eriwen:gradle-cobertura-plugin:1.1.1'
        }
    }
    
    group 'org.company'
    version '1.0-SNAPSHOT'
    
    
    apply plugin: 'groovy'
    apply plugin: 'cobertura'
    
    sourceCompatibility = 1.8
    
    repositories {
        mavenCentral()
    }
    
    
    dependencies {
        implementation 'org.codehaus.groovy:groovy-all:3.0.7'
        testImplementation 'org.junit.jupiter:junit-jupiter-api:5.3.1'
        testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.3.1'
        testImplementation 'org.mockito:mockito-core:2.+'
    }
    
    test {
    	// this is only for the cobertura
        jvmArgs '-noverify'
        // needed for JUnit
        useJUnitPlatform()
    }
    
    sourceSets {
        main {
            groovy {
                // all code files will be in either of the folders
                srcDirs = ['src', 'vars']
            }
        }
        test {
            groovy {
                srcDirs = ['test']
            }
        }
    }
    
    // Optional for test coverage of Groovy files
    cobertura {
        format = 'html'
        includes = ['**/*.groovy']
        excludes = []
        reportsDir = file("./reports")
    }